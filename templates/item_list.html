{% extends "base.html" %}
{% load static %}
{% block title %}Products{% endblock %}
{% block content %}
    <div id="main" class="product-list">
        {% for item in items %}
            <div class="item">
                <h1>{{ item.name }}</h1>
                <div class="item-description">{{ item.description }}</div>
                <div class="item-price">{{ item.price }} ₽</div>
                <a href="{% url 'item_detail' item.id %}">View Details</a>
                <button class="buy-button"
                        data-item-id="{{ item.id }}"
                        data-stripe-key="{{ stripe_publishable_key }}">
                    Купить
                </button>
                {{ stripe_publishable_key }}
            </div>
        {% endfor %}
    </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buyButtons = document.querySelectorAll('.buy-button');

            buyButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const itemId = this.getAttribute('data-item-id');
                    const stripeKey = this.getAttribute('data-stripe-key');
                    const stripe = Stripe(stripeKey);

                    fetch(`/buy/${itemId}`, {
                        method: 'GET',
                    })
                        .then(response => response.json())
                        .then(session => {
                            return stripe.redirectToCheckout({sessionId: session.sessionId});
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                });
            });
        });
    </script>
{% endblock %}